<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UCAQ - Inicialização do Banco de Dados</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/components.css">
    <style>
        .progress-container {
            width: 100%;
            margin: 20px 0;
        }

        .progress-bar {
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
        }

        .status {
            margin-top: 10px;
            font-style: italic;
        }

        .log-container {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
        }

        .success {
            color: #4CAF50;
        }

        .error {
            color: #f44336;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="header">Inicialização do Banco de Dados</h1>

        <div class="card">
            <h2>Migrando para SQLite</h2>
            <p>Este processo irá migrar os dados existentes do localStorage para um banco de dados SQLite mais robusto.
            </p>

            <div class="progress-container">
                <div class="progress-bar">
                    <div id="progress" class="progress"></div>
                </div>
                <div id="status" class="status">Aguardando inicialização...</div>
            </div>

            <div class="form-actions">
                <button id="startButton" class="btn-registrar" onclick="startMigration()">
                    <i class="fas fa-database"></i> Iniciar Migração
                </button>

                <button id="homeButton" class="btn-secondary" onclick="goToHome()" style="display: none;">
                    <i class="fas fa-home"></i> Voltar para Home
                </button>
            </div>

            <div id="logContainer" class="log-container" style="display: none;"></div>
        </div>
    </div>

    <!-- Carregar SQL.js com referência correta ao arquivo wasm -->
    <script>
        // Configurar o diretório do arquivo wasm antes de carregar o SQL.js
        window.SQL = {
            locateFile: filename => `./wasm/${filename}`
        };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>

    <!-- Carregar nosso módulo de banco de dados -->
    <script src="js/database.js"></script>

    <script>
        let migrationStarted = false;

        // Adiciona um log na interface
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            if (!logContainer.style.display || logContainer.style.display === 'none') {
                logContainer.style.display = 'block';
            }

            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = message;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Atualiza a barra de progresso
        function updateProgress(percent, message) {
            document.getElementById('progress').style.width = percent + '%';
            document.getElementById('status').textContent = message;
        }

        // Verifica se o WebAssembly é suportado pelo navegador
        function checkWebAssemblySupport() {
            try {
                if (typeof WebAssembly === 'object'
                    && typeof WebAssembly.instantiate === 'function'
                    && typeof WebAssembly.compile === 'function') {

                    const module = new WebAssembly.Module(new Uint8Array([
                        0x0, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00
                    ]));

                    if (module instanceof WebAssembly.Module) {
                        const instance = new WebAssembly.Instance(module);
                        return instance instanceof WebAssembly.Instance;
                    }
                }
            } catch (e) { }

            return false;
        }

        // Inicia o processo de migração
        async function startMigration() {
            if (migrationStarted) return;
            migrationStarted = true;

            document.getElementById('startButton').disabled = true;
            updateProgress(5, 'Verificando compatibilidade...');

            // Verifica se o WebAssembly é suportado
            if (!checkWebAssemblySupport()) {
                addLog('ERRO: WebAssembly não é suportado por este navegador. O SQLite não pode ser inicializado.', 'error');
                updateProgress(0, 'Falha: WebAssembly não suportado');
                document.getElementById('startButton').disabled = false;
                migrationStarted = false;
                return;
            }

            addLog('WebAssembly é suportado. Iniciando SQLite...', 'success');
            updateProgress(10, 'Iniciando o banco de dados SQLite...');

            try {
                // Inicializa o banco de dados
                addLog('Inicializando SQLite...');
                const initialized = await window.db.init();

                if (!initialized) {
                    throw new Error('Falha ao inicializar o banco de dados SQLite');
                }

                addLog('SQLite inicializado com sucesso!', 'success');
                updateProgress(30, 'Migrando dados do localStorage...');

                // Migra os dados do localStorage
                addLog('Iniciando migração de dados...');
                const migrated = await window.db.migrate();

                if (!migrated) {
                    throw new Error('Falha ao migrar dados do localStorage');
                }

                addLog('Migração de dados concluída com sucesso!', 'success');
                updateProgress(70, 'Salvando banco de dados...');

                // Salva o banco de dados
                window.db.save();
                addLog('Banco de dados salvo com sucesso!', 'success');

                // Marca como inicializado
                localStorage.setItem('sqlite_initialized', 'true');

                // Migração concluída
                updateProgress(100, 'Migração concluída com sucesso!');
                addLog('Processo de migração concluído! O sistema agora está usando SQLite.', 'success');

                // Mostra o botão para voltar à página inicial
                document.getElementById('homeButton').style.display = 'inline-block';
            } catch (error) {
                console.error('Erro durante a migração:', error);
                addLog('ERRO: ' + error.message, 'error');
                updateProgress(0, 'Falha na migração: ' + error.message);

                // Reativa o botão para tentar novamente
                document.getElementById('startButton').disabled = false;
                migrationStarted = false;
            }
        }

        // Volta para a página inicial
        function goToHome() {
            window.location.href = 'index.html';
        }
    </script>
</body>

</html>